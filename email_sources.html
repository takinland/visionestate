<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ“‘ Ù…Ù†Ø§Ø¨Ø¹ Ø§ÛŒÙ…ÛŒÙ„</title>
  <style>
    body {
      font-family: Tahoma, 'Vazir', sans-serif;
      background-color: #f9f9f9;
      padding: 20px;
      direction: rtl;
    }
    h2 { text-align: center; color: #333; }
    table {
      width: 100%; border-collapse: collapse;
      margin-top: 20px; background: #fff;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px; text-align: right;
    }
    th { background-color: #eee; }
    input, button {
      font-family: inherit;
      padding: 6px;
    }
    .form-inline {
      margin-top: 30px;
      background: #fff;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <h2>ğŸ“‘ Ù…Ù†Ø§Ø¨Ø¹ Ø§ÛŒÙ…ÛŒÙ„</h2>

  <table id="dataTable">
    <thead>
      <tr id="headerRow"></tr>
      <tr id="filterRow" class="filter-row"></tr>
    </thead>
    <tbody id="tableBody">
      <tr><td colspan="99">â³ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</td></tr>
    </tbody>
  </table>

  <div class="form-inline">
    <h3>â• Ø§ÙØ²ÙˆØ¯Ù† Ù…Ù†Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯</h3>
    <form id="addForm">
      <div id="addFields"></div>
      <button type="submit">Ø§ÙØ²ÙˆØ¯Ù†</button>
    </form>
  </div>

  <!-- Supabase SDK -->
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

    const supabaseUrl = 'https://tdvimwqotnuvcdvhvbjj.supabase.co'
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRkdmltd3FvdG51dmNkdmh2YmpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkxMDY2MjcsImV4cCI6MjA2NDY4MjYyN30.CWNPk-S-ECq0c1LRugDJYOchY3mgC2Zchyr8X8-mDeE'
    const supabase = createClient(supabaseUrl, supabaseKey)


    const tableName = 'email_sources'
    const allFields = ['name', 'description']

    async function fetchData() {
      const { data, error } = await supabase.from(tableName).select('*')
      if (error) {
        alert('âš ï¸ Ø®Ø·Ø§ Ø¯Ø± ÙˆØ§Ú©Ø´ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª: ' + error.message)
        console.error(error)
      } else {
        renderTable(data)
      }
    }

    function renderTable(data) {
      const headerRow = document.getElementById('headerRow')
      const filterRow = document.getElementById('filterRow')
      const tableBody = document.getElementById('tableBody')
      const addFields  = document.getElementById('addFields')

      headerRow.innerHTML = ''
      filterRow.innerHTML = ''
      tableBody.innerHTML = ''
      addFields.innerHTML = ''

      // Header + Filters
      allFields.forEach(field => {
        const th = document.createElement('th')
        th.textContent = field
        headerRow.appendChild(th)

        const tf = document.createElement('th')
        const input = document.createElement('input')
        input.placeholder = 'ÙÛŒÙ„ØªØ±...'
        input.dataset.field = field
        input.addEventListener('input', applyFilter)
        tf.appendChild(input)
        filterRow.appendChild(tf)
      })

      // Actions header
      const thActions = document.createElement('th')
      thActions.textContent = 'Ø§Ù‚Ø¯Ø§Ù…Ø§Øª'
      headerRow.appendChild(thActions)
      const thActionsFilter = document.createElement('th')
      filterRow.appendChild(thActionsFilter)

      if (!data || data.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="${allFields.length + 1}">ğŸ“­ Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</td></tr>`
        return
      }

      // Rows
      data.forEach(row => {
        const tr = document.createElement('tr')
        const rowInputs = {}

        allFields.forEach(field => {
          const td = document.createElement('td')
          const input = document.createElement('input')
          input.value = row[field] ?? ''
          input.dataset.field = field
          rowInputs[field] = input
          td.appendChild(input)
          tr.appendChild(td)
        })

        const actionsTd = document.createElement('td')

        // Update button
        const updateBtn = document.createElement('button')
        updateBtn.textContent = 'âœï¸ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ'
        updateBtn.onclick = async () => {
          const updated = {}
          allFields.forEach(field => (updated[field] = rowInputs[field].value))

          const { error } =
