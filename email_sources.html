<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ“‘ Ù…Ù†Ø§Ø¨Ø¹ Ø§ÛŒÙ…ÛŒÙ„</title>
  <style>
    body{font-family:Tahoma,'Vazir',sans-serif;background:#f9f9f9;padding:20px}
    h2{text-align:center;color:#333}
    table{width:100%;border-collapse:collapse;margin-top:20px;background:#fff}
    th,td{border:1px solid #ccc;padding:8px;text-align:right}
    th{background:#eee}
    input,button{font-family:inherit;padding:6px}
    .form-inline{margin-top:30px;background:#fff;padding:15px;border-radius:10px;box-shadow:0 0 5px rgba(0,0,0,.1)}
    #status{float:left;background:#fff;padding:6px 10px;border:1px solid #ddd;border-radius:6px}
    #error{white-space:pre-wrap;color:#b00020;background:#fff;padding:10px;border-radius:8px;border:1px dashed #b00020;margin-top:16px;display:none}
  </style>
</head>
<body>
  <h2>Ù…Ù†Ø§Ø¨Ø¹ Ø§ÛŒÙ…ÛŒÙ„ ğŸ“„</h2>
  <div id="status">â³ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒâ€¦</div>

  <table id="dataTable">
    <thead>
      <tr id="headerRow"></tr>
      <tr id="filterRow" class="filter-row"></tr>
    </thead>
    <tbody id="tableBody">
      <tr><td colspan="99">â³ â€¦</td></tr>
    </tbody>
  </table>

  <div class="form-inline">
    <h3>â• Ø§ÙØ²ÙˆØ¯Ù† Ù…Ù†Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯</h3>
    <form id="addForm">
      <div id="addFields"></div>
      <button type="submit">Ø§ÙØ²ÙˆØ¯Ù†</button>
    </form>
  </div>

  <div id="error"></div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

    // ğŸ”‘ Ø­ØªÙ…Ø§Ù‹ Ø¨Ø§ Ù…Ù‚Ø§Ø¯ÛŒØ± Ù¾Ø±ÙˆÚ˜Ù‡ Ø®ÙˆØ¯Øª ÛŒÚ©ÛŒ Ø¨Ø§Ø´Ø¯
    const supabaseUrl = 'https://tdvimwqotnuvcdvhvbjj.supabase.co'
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRkdmltd3FvdG51dmNkdmh2YmpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkxMDY2MjcsImV4cCI6MjA2NDY4MjYyN30.CWNPk-S-ECq0c1LRugDJYOchY3mgC2Zchyr8X8-mDeE'

    const supabase = createClient(supabaseUrl, supabaseKey, { auth: { persistSession: false } })
    const tableName = 'email_sources'
    const allFields = ['name','description']

    const $ = s => document.querySelector(s)
    const status = $('#status')
    const errorBox = $('#error')

    function showError(msg, err) {
      console.error(msg, err)
      errorBox.style.display = 'block'
      errorBox.textContent = `${msg}\n${err?.message || err || ''}`
      status.textContent = 'âŒ Ø®Ø·Ø§'
    }

    async function fetchData() {
      status.textContent = 'â³ ÙˆØ§Ú©Ø´ÛŒ Ø¯Ø§Ø¯Ù‡â€¦'
      const { data, error } = await supabase.from(tableName).select('*').order('id', { ascending: true })
      if (error) return showError('Ø®Ø·Ø§ Ø¯Ø± ÙˆØ§Ú©Ø´ÛŒ Ø¯Ø§Ø¯Ù‡ Ø§Ø² Supabase:', error)
      renderTable(data)
      status.textContent = 'âœ… Ø¢Ù…Ø§Ø¯Ù‡'
    }

    function renderTable(data) {
      const headerRow = $('#headerRow')
      const filterRow = $('#filterRow')
      const tableBody = $('#tableBody')
      const addFields  = $('#addFields')
      headerRow.innerHTML = filterRow.innerHTML = tableBody.innerHTML = addFields.innerHTML = ''

      // headers + filters
      allFields.forEach(field => {
        const th = document.createElement('th'); th.textContent = field; headerRow.appendChild(th)
        const tf = document.createElement('th')
        const input = document.createElement('input'); input.placeholder='ÙÛŒÙ„ØªØ±â€¦'; input.dataset.field=field
        input.addEventListener('input', applyFilter)
        tf.appendChild(input); filterRow.appendChild(tf)
      })
      const thAct = document.createElement('th'); thAct.textContent='Ø§Ù‚Ø¯Ø§Ù…Ø§Øª'; headerRow.appendChild(thAct)
      filterRow.appendChild(document.createElement('th'))

      if (!data || data.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="${allFields.length+1}">ğŸ“­ Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</td></tr>`
        return
      }

      data.forEach(row => {
        const tr = document.createElement('tr')
        const rowInputs = {}
        allFields.forEach(field => {
          const td = document.createElement('td')
          const input = document.createElement('input')
          input.value = row[field] ?? ''
          input.dataset.field = field
          rowInputs[field] = input
          td.appendChild(input); tr.appendChild(td)
        })
        const actionsTd = document.createElement('td')

        const updateBtn = document.createElement('button')
        updateBtn.textContent = 'âœï¸ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ'
        updateBtn.onclick = async () => {
          const payload = {}; allFields.forEach(f => payload[f] = rowInputs[f].value)
          const { error } = await supabase.from(tableName).update(payload).eq('id', row.id)
          if (error) return showError('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ:', error)
          alert('âœ… Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯')
        }
        actionsTd.appendChild(updateBtn)

        const delBtn = document.createElement('button')
        delBtn.textContent = 'ğŸ—‘ Ø­Ø°Ù'; delBtn.style.marginRight='10px'
        delBtn.onclick = async () => {
          if (!confirm('Ø­Ø°Ù Ø§ÛŒÙ† Ø±Ø¯ÛŒÙØŸ')) return
          const { error } = await supabase.from(tableName).delete().eq('id', row.id)
          if (error) return showError('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù:', error)
          tr.remove()
        }
        actionsTd.appendChild(delBtn)

        tr.appendChild(actionsTd); tableBody.appendChild(tr)
      })

      // add form
      allFields.forEach(field => {
        const input = document.createElement('input'); input.name=field; input.placeholder=field
        addFields.appendChild(input)
      })
    }

    async function applyFilter() {
      const filters = Array.from(document.querySelectorAll('.filter-row input'))
        .filter(i => i.value.trim() !== '')
        .map(i => ({ field: i.dataset.field, value: i.value.trim() }))
      let query = supabase.from(tableName).select('*')
      filters.forEach(f => { query = query.ilike(f.field, `%${f.value}%`) })
      const { data, error } = await query
      if (error) return showError('Ø®Ø·Ø§ Ø¯Ø± ÙÛŒÙ„ØªØ±:', error)
      renderTable(data)
    }

    document.getElementById('addForm').addEventListener('submit', async e => {
      e.preventDefault()
      const formData = new FormData(e.target)
      const rec = {}; for (let [k,v] of formData.entries()) rec[k]=v
      const { error } = await supabase.from(tableName).insert([rec])
      if (error) return showError('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±Ø¬ Ø¯Ø§Ø¯Ù‡:', error)
      e.target.reset(); fetchData()
    })

    fetchData()
  </script>
</body>
</html>
