<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>📂 گروه‌های ایمیل</title>
  <style>
    body {
      font-family: Tahoma, 'Vazir', sans-serif;
      background-color: #f9f9f9;
      padding: 20px;
      direction: rtl;
    }
    h2 { text-align: center; color: #333; }
    table {
      width: 100%; border-collapse: collapse;
      margin-top: 20px; background: #fff;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px; text-align: right;
    }
    th { background-color: #eee; }
    input, button {
      font-family: inherit;
      padding: 6px;
    }
    .form-inline {
      margin-top: 30px;
      background: #fff;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <h2>📂 گروه‌های ایمیل</h2>

  <table id="dataTable">
    <thead>
      <tr id="headerRow"></tr>
      <tr id="filterRow" class="filter-row"></tr>
    </thead>
    <tbody id="tableBody">
      <tr><td colspan="99">⏳ در حال بارگذاری...</td></tr>
    </tbody>
  </table>

  <div class="form-inline">
    <h3>➕ افزودن گروه جدید</h3>
    <form id="addForm">
      <div id="addFields"></div>
      <button type="submit">افزودن</button>
    </form>
  </div>

  <!-- Supabase SDK -->
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

    const supabaseUrl = 'https://tdvimwqotnuvcdvhvbjj.supabase.co'
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRkdmltd3FvdG51dmNkdmh2YmpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkxMDY2MjcsImV4cCI6MjA2NDY4MjYyN30.CWNPk-S-ECq0c1LRugDJYOchY3mgC2Zchyr8X8-mDeE'
    const supabase = createClient(supabaseUrl, supabaseKey)

    const tableName = 'email_groups'
    const allFields = ['name', 'description']

    async function fetchData() {
      const { data, error } = await supabase.from(tableName).select('*')
      if (error) {
        alert('⚠️ خطا در واکشی اطلاعات: ' + error.message)
        console.error(error)
      } else {
        renderTable(data)
      }
    }

    function renderTable(data) {
      const headerRow = document.getElementById('headerRow')
      const filterRow = document.getElementById('filterRow')
      const tableBody = document.getElementById('tableBody')
      const addFields = document.getElementById('addFields')

      headerRow.innerHTML = ''
      filterRow.innerHTML = ''
      tableBody.innerHTML = ''
      addFields.innerHTML = ''

      allFields.forEach(field => {
        const th = document.createElement('th')
        th.textContent = field
        headerRow.appendChild(th)

        const tf = document.createElement('th')
        const input = document.createElement('input')
        input.placeholder = 'فیلتر...'
        input.dataset.field = field
        input.addEventListener('input', applyFilter)
        tf.appendChild(input)
        filterRow.appendChild(tf)
      })

      if (!data || data.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="${allFields.length}">📭 داده‌ای یافت نشد.</td></tr>`
        return
      }
data.forEach(row => {
  const tr = document.createElement('tr')

  const rowInputs = {}

  allFields.forEach(field => {
    const td = document.createElement('td')
    const input = document.createElement('input')
    input.value = row[field] ?? ''
    input.dataset.field = field
    rowInputs[field] = input
    td.appendChild(input)
    tr.appendChild(td)
  })

  const actionsTd = document.createElement('td')

  // دکمه بروزرسانی
  const updateBtn = document.createElement('button')
  updateBtn.textContent = '✏️ بروزرسانی'
  updateBtn.onclick = async () => {
    const updated = {}
    allFields.forEach(field => {
      updated[field] = rowInputs[field].value
    })

    const { error } = await supabase.from(tableName).update(updated).eq('id', row.id)
    if (error) {
      alert('❌ خطا در بروزرسانی: ' + error.message)
      console.error(error)
    } else {
      alert('✅ بروزرسانی با موفقیت انجام شد')
    }
  }
  actionsTd.appendChild(updateBtn)

  // دکمه حذف
  const delBtn = document.createElement('button')
  delBtn.textContent = '🗑 حذف'
  delBtn.style.marginRight = '10px'
  delBtn.onclick = async () => {
    if (confirm('حذف این ردیف؟')) {
      const { error } = await supabase.from(tableName).delete().eq('id', row.id)
      if (error) {
        alert('❌ خطا در حذف: ' + error.message)
        console.error(error)
      } else {
        tr.remove()
      }
    }
  }
  actionsTd.appendChild(delBtn)

  tr.appendChild(actionsTd)
  tableBody.appendChild(tr)
})


      // فرم افزودن
      allFields.forEach(field => {
        const input = document.createElement('input')
        input.name = field
        input.placeholder = field
        addFields.appendChild(input)
      })
    }

    async function applyFilter() {
      const filters = Array.from(document.querySelectorAll('.filter-row input'))
        .filter(input => input.value.trim() !== '')
        .map(input => ({ field: input.dataset.field, value: input.value.trim() }))

      let query = supabase.from(tableName).select('*')

      filters.forEach(f => {
        query = query.ilike(f.field, `%${f.value}%`)
      })

      const { data, error } = await query
      if (error) {
        alert('⚠️ خطا در فیلتر: ' + error.message)
      } else {
        renderTable(data)
      }
    }

    document.getElementById('addForm').addEventListener('submit', async e => {
      e.preventDefault()
      const form = e.target
      const formData = new FormData(form)
      const record = {}

      for (let [key, val] of formData.entries()) {
        record[key] = val
      }

      const { error } = await supabase.from(tableName).insert([record])
if (error) {
  alert('❌ خطا در درج داده: ' + error.message)
  console.error(error)
}

      form.reset()
      fetchData()
    })

    fetchData()
  </script>
</body>
</html>
