<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ø¨Ø§Ù†Ú© Ø§ÛŒÙ…ÛŒÙ„ Ø§ÛŒØ±Ø§Ù† â€” ÙÛŒÙ„ØªØ± Ù¾ÛŒØ´Ø±ÙØªÙ‡ + Ø§Ø±Ø³Ø§Ù„ Ú¯Ø±ÙˆÙ‡ÛŒ</title>
  <style>
    body{font-family:Tahoma,'Vazir',sans-serif;background:#f7f7f7;margin:0;padding:24px}
    h2{margin:0 0 16px;text-align:center}
    .panel{background:#fff;border:1px solid #e5e5e5;border-radius:12px;padding:16px;margin-bottom:16px}
    .filters{display:grid;grid-template-columns:repeat(6,1fr);gap:12px}
    .filters .wide{grid-column: span 2}
    label{display:block;font-size:12px;margin-bottom:6px;color:#444}
    input,select{width:100%;padding:8px;border:1px solid #ddd;border-radius:8px;font-family:inherit}
    .row{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-top:12px}
    .btn{padding:8px 14px;border:1px solid #ddd;background:#fff;border-radius:8px;cursor:pointer}
    .btn.primary{background:#0ea5e9;border-color:#0ea5e9;color:#fff}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    #status{font-size:12px;color:#666}
    #error{white-space:pre-wrap;color:#b00020;background:#fff;border:1px dashed #b00020;border-radius:8px;padding:10px;display:none;margin-bottom:12px}
    table{width:100%;border-collapse:collapse;background:#fff;border:1px solid #e5e5e5;border-radius:12px;overflow:hidden}
    th,td{border-bottom:1px solid #eee;padding:8px 10px;text-align:right;font-size:13px}
    th{background:#fafafa}
    .badge{display:inline-block;background:#eef6ff;color:#0369a1;border:1px solid #cfe8ff;border-radius:999px;padding:4px 10px;font-size:12px}
    .pagination{display:flex;gap:8px;align-items:center}
  </style>
</head>
<body>
  <h2>Ø¨Ø§Ù†Ú© Ø§ÛŒÙ…ÛŒÙ„ Ø§ÛŒØ±Ø§Ù† â€” ÙÛŒÙ„ØªØ± Ù¾ÛŒØ´Ø±ÙØªÙ‡</h2>

  <div id="error"></div>

  <div class="panel">
    <div class="filters">
      <div>
        <label>Ø§ÛŒÙ…ÛŒÙ„</label>
        <input id="f_email" placeholder="Ù…Ø«Ø§Ù„: @gmail.com ÛŒØ§ ali@" />
      </div>
      <div>
        <label>Ù†Ø§Ù… Ù…Ø®Ø§Ø·Ø¨ (contact_person)</label>
        <input id="f_contact" placeholder="Ù…Ø«Ø§Ù„: Nader" />
      </div>
      <div>
        <label>Ø³Ø§Ø²Ù…Ø§Ù†</label>
        <input id="f_org" placeholder="Ù…Ø«Ø§Ù„: Holding" />
      </div>
      <div>
        <label>Ú©Ø´ÙˆØ±</label>
        <input id="f_country" placeholder="Iran / UAE / ..." />
      </div>
      <div>
        <label>Ø§Ø³ØªØ§Ù† (provience)</label>
        <input id="f_prov" placeholder="Tehran / ..."/>
      </div>
      <div>
        <label>Ø´Ù‡Ø±</label>
        <input id="f_city" placeholder="Tehran / Mashhad / ..." />
      </div>

      <div>
        <label>Ù…Ù†Ø·Ù‚Ù‡ (district)</label>
        <input id="f_dist" placeholder="all / 1 / 6 ..." />
      </div>
      <div>
        <label>Ú¯Ø±ÙˆÙ‡</label>
        <select id="f_group"><option value="">Ù‡Ù…Ù‡</option></select>
      </div>
      <div>
        <label>Ù…Ù†Ø¨Ø¹</label>
        <select id="f_source"><option value="">Ù‡Ù…Ù‡</option></select>
      </div>
      <div>
        <label>ÙØ¹Ø§Ù„/ØºÛŒØ±ÙØ¹Ø§Ù„</label>
        <select id="f_active">
          <option value="">Ù‡Ù…Ù‡</option>
          <option value="true">ÙØ¹Ø§Ù„</option>
          <option value="false">ØºÛŒØ±ÙØ¹Ø§Ù„</option>
        </select>
      </div>
      <div>
        <label>Unsubscribed by</label>
        <select id="f_unsub">
          <option value="">Ù‡Ù…Ù‡</option>
          <option value="admin">admin</option>
          <option value="user">user</option>
          <option value="NULL">Ø¨Ø¯ÙˆÙ† Ù…Ù‚Ø¯Ø§Ø±</option>
        </select>
      </div>
      <div>
        <label>ØªØ¹Ø¯Ø§Ø¯ Ø§Ø±Ø³Ø§Ù„ (min - max)</label>
        <div style="display:flex;gap:6px">
          <input id="f_send_min" type="number" placeholder="min" />
          <input id="f_send_max" type="number" placeholder="max" />
        </div>
      </div>

      <div class="wide">
        <label>ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§ (notes)</label>
        <input id="f_notes" placeholder="Ù…ØªÙ† Ø¢Ø²Ø§Ø¯..." />
      </div>

      <div>
        <label>Ø§Ø² ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯</label>
        <input id="f_created_from" type="date" />
      </div>
      <div>
        <label>ØªØ§ ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯</label>
        <input id="f_created_to" type="date" />
      </div>
      <div>
        <label>Ø§Ø² Ø¢Ø®Ø±ÛŒÙ† Ø§Ø±Ø³Ø§Ù„</label>
        <input id="f_last_from" type="date" />
      </div>
      <div>
        <label>ØªØ§ Ø¢Ø®Ø±ÛŒÙ† Ø§Ø±Ø³Ø§Ù„</label>
        <input id="f_last_to" type="date" />
      </div>
    </div>

    <div class="row">
      <div class="badge">ØªØ¹Ø¯Ø§Ø¯ Ù†ØªØ§ÛŒØ¬: <span id="count">0</span></div>
      <div>
        <button class="btn" id="btnReset">Ø±ÛŒØ³Øª ÙÛŒÙ„ØªØ±Ù‡Ø§</button>
        <button class="btn primary" id="btnApply">Ø§Ø¹Ù…Ø§Ù„ ÙÛŒÙ„ØªØ±</button>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div id="status">â³ Ø¢Ù…Ø§Ø¯Ù‡</div>
      <div class="pagination">
        <button class="btn" id="prevBtn">Ù‚Ø¨Ù„ÛŒ</button>
        <span class="badge">ØµÙØ­Ù‡: <span id="pageInfo">1</span></span>
        <button class="btn" id="nextBtn">Ø¨Ø¹Ø¯ÛŒ</button>
        <select id="pageSize" class="btn">
          <option value="10">Û±Û°</option>
          <option value="25" selected>Û²Ûµ</option>
          <option value="50">ÛµÛ°</option>
        </select>
      </div>
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th style="width:42px"><input id="selAll" type="checkbox" title="Ø§Ù†ØªØ®Ø§Ø¨ Ù‡Ù…Ù‡" /></th>
        <th>Ø§ÛŒÙ…ÛŒÙ„</th>
        <th>Ù†Ø§Ù…</th>
        <th>Ú¯Ø±ÙˆÙ‡</th>
        <th>Ù…Ù†Ø¨Ø¹</th>
        <th>ÙØ¹Ø§Ù„</th>
        <th>Ø§Ø±Ø³Ø§Ù„â€ŒÙ‡Ø§</th>
        <th>Ø¢Ø®Ø±ÛŒÙ† Ø§Ø±Ø³Ø§Ù„</th>
        <th>Ø³Ø§Ø²Ù…Ø§Ù†</th>
        <th>Ú©Ø´ÙˆØ±/Ø§Ø³ØªØ§Ù†/Ø´Ù‡Ø±/Ù†Ø§Ø­ÛŒÙ‡</th>
        <th>Ø§ÛŒØ¬Ø§Ø¯</th>
        <th>Unsub by</th>
        <th>ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</th>
      </tr>
    </thead>
    <tbody id="tbody">
      <tr><td colspan="13">â³ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒâ€¦</td></tr>
    </tbody>
  </table>

  <!-- Ù†ÙˆØ§Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ù‚Ø§Ù„Ø¨/Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´/Ø§Ø±Ø³Ø§Ù„ -->
  <div id="bulk-template-bar" class="panel" style="margin-top:16px">
    <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center;">
      <label style="min-width:90px;">Ø§Ù†ØªØ®Ø§Ø¨ Ù‚Ø§Ù„Ø¨:</label>
      <select id="tplSelect" style="min-width:260px; padding:8px; border-radius:8px; border:1px solid #d1d5db;">
        <option value="">â€” Ø§Ù†ØªØ®Ø§Ø¨ Ù‚Ø§Ù„Ø¨ â€”</option>
      </select>

      <label style="min-width:60px;">Ù…ÙˆØ¶ÙˆØ¹:</label>
      <input id="emailSubject" type="text" placeholder="Ù…ÙˆØ¶ÙˆØ¹ Ø§ÛŒÙ…ÛŒÙ„â€¦" style="flex:1; min-width:260px; padding:8px; border-radius:8px; border:1px solid #d1d5db;" />

      <button id="previewTpl" class="btn">Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´</button>
      <button id="sendBulk" class="btn primary">Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡â€ŒÙ‡Ø§</button>
    </div>

    <div id="tplPreviewWrap" style="margin-top:14px; display:none;">
      <div style="margin-bottom:8px; color:#6b7280; font-size:12px;">Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ø±ÙˆÛŒ Ø§ÙˆÙ„ÛŒÙ† Ú¯ÛŒØ±Ù†Ø¯Ù‡Ù” Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡</div>
      <iframe id="tplPreview" style="width:100%; height:420px; border:1px solid #e5e5e5; border-radius:12px; background:#fff;"></iframe>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

    // âœ… Ø¢Ø¯Ø±Ø³ Ùˆ Ú©Ù„ÛŒØ¯ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒØ§Øª
    const supabaseUrl = 'https://tdvimwqotnuvcdvhvbjj.supabase.co'
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRkdmltd3FvdG51dmNkdmh2YmpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkxMDY2MjcsImV4cCI6MjA2NDY4MjYyN30.CWNPk-S-ECq0c1LRugDJYOchY3mgC2Zchyr8X8-mDeE'
    const supabase = createClient(supabaseUrl, supabaseKey, { auth: { persistSession: false } })

    const tableName = 'iran_emails_bank'
    const tbody = document.getElementById('tbody')
    const statusEl = document.getElementById('status')
    const errorBox = document.getElementById('error')
    const countEl = document.getElementById('count')
    const pageInfo = document.getElementById('pageInfo')
    const pageSizeSel = document.getElementById('pageSize')

    let page = 1, totalRows = 0, currentRows = []

    const $ = id => document.getElementById(id)

    function showError(msg, err) {
      console.error(msg, err)
      errorBox.style.display = 'block'
      errorBox.textContent = `${msg}\n${err?.message || err || ''}`
      statusEl.textContent = 'âŒ Ø®Ø·Ø§'
    }

    async function loadOptions() {
      const g = await supabase.from('email_groups').select('id,name').order('id',{ascending:true})
      if (!g.error) g.data.forEach(x => { const o=document.createElement('option'); o.value=x.id; o.textContent=`${x.id} â€” ${x.name}`; $('f_group').appendChild(o)})
      const s = await supabase.from('email_sources').select('id,name').order('id',{ascending:true})
      if (!s.error) s.data.forEach(x => { const o=document.createElement('option'); o.value=x.id; o.textContent=`${x.id} â€” ${x.name}`; $('f_source').appendChild(o)})
    }

    function applyFiltersTo(query) {
      const email=$('f_email').value.trim(), contact=$('f_contact').value.trim(), org=$('f_org').value.trim()
      const country=$('f_country').value.trim(), prov=$('f_prov').value.trim(), city=$('f_city').value.trim(), dist=$('f_dist').value.trim()
      const group=$('f_group').value, source=$('f_source').value, active=$('f_active').value, unsub=$('f_unsub').value
      const notes=$('f_notes').value.trim(), sendMin=$('f_send_min').value, sendMax=$('f_send_max').value
      const createdFrom=$('f_created_from').value, createdTo=$('f_created_to').value
      const lastFrom=$('f_last_from').value, lastTo=$('f_last_to').value

      if (email)   query = query.ilike('email', `%${email}%`)
      if (contact) query = query.ilike('contact_person', `%${contact}%`)
      if (org)     query = query.ilike('organization', `%${org}%`)
      if (country) query = query.ilike('country', `%${country}%`)
      if (prov)    query = query.ilike('provience', `%${prov}%`)
      if (city)    query = query.ilike('city', `%${city}%`)
      if (dist)    query = query.ilike('district', `%${dist}%`)
      if (notes)   query = query.ilike('notes', `%${notes}%`)
      if (group)   query = query.eq('group_id', Number(group))
      if (source)  query = query.eq('source_id', Number(source))
      if (active !== '') query = query.eq('is_active', active === 'true')
      if (unsub === 'admin' || unsub === 'user') query = query.eq('unsubscribed_by', unsub)
      if (unsub === 'NULL') query = query.is('unsubscribed_by', null)
      if (sendMin) query = query.gte('send_count', Number(sendMin))
      if (sendMax) query = query.lte('send_count', Number(sendMax))
      if (createdFrom) query = query.gte('created_at', new Date(createdFrom).toISOString())
      if (createdTo)   query = query.lte('created_at', new Date(new Date(createdTo).getTime()+86400000-1).toISOString())
      if (lastFrom)    query = query.gte('last_sent_at', new Date(lastFrom).toISOString())
      if (lastTo)      query = query.lte('last_sent_at', new Date(new Date(lastTo).getTime()+86400000-1).toISOString())
      return query
    }

    async function fetchPage() {
      statusEl.textContent = 'â³ ÙˆØ§Ú©Ø´ÛŒ Ø¯Ø§Ø¯Ù‡â€¦'
      const size = Number(pageSizeSel.value), from = (page-1)*size, to = from+size-1
      let q = supabase.from(tableName)
        .select('id,email,contact_person,group_id,source_id,is_active,send_count,last_sent_at,organization,country,provience,city,district,created_at,unsubscribed_by,notes',{count:'exact'})
        .order('created_at',{ascending:false}).range(from,to)
      q = applyFiltersTo(q)
      const { data, count, error } = await q
      if (error) { showError('Ø®Ø·Ø§ Ø¯Ø± ÙˆØ§Ú©Ø´ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§', error); return }
      totalRows = count ?? 0; countEl.textContent = totalRows; pageInfo.textContent = page
      renderRows(data||[]); statusEl.textContent='âœ… Ø¢Ù…Ø§Ø¯Ù‡'
    }

    function renderRows(rows){
      currentRows = rows||[]
      if(!currentRows.length){ tbody.innerHTML=`<tr><td colspan="13">ğŸ“­ Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ù†ÛŒØ³Øª.</td></tr>`; return }
      tbody.innerHTML = currentRows.map(r=>`
        <tr>
          <td><input type="checkbox" class="rowSel" data-id="${r.id}" /></td>
          <td>${r.email??''}</td>
          <td>${r.contact_person??''}</td>
          <td>${r.group_id??''}</td>
          <td>${r.source_id??''}</td>
          <td>${r.is_active?'âœ…':'â›”'}</td>
          <td>${r.send_count??0}</td>
          <td>${r.last_sent_at?new Date(r.last_sent_at).toLocaleString():'-'}</td>
          <td>${r.organization??''}</td>
          <td>${[r.country,r.provience,r.city,r.district].filter(Boolean).join(' / ')}</td>
          <td>${r.created_at?new Date(r.created_at).toLocaleString():''}</td>
          <td>${r.unsubscribed_by??''}</td>
          <td>${r.notes??''}</td>
        </tr>
      `).join('')
      const selAll = document.getElementById('selAll')
      if(selAll){ selAll.checked=false; selAll.onchange=()=>{ document.querySelectorAll('.rowSel').forEach(cb=>cb.checked=selAll.checked) } }
    }

    document.getElementById('btnApply').addEventListener('click', async()=>{ errorBox.style.display='none'; page=1; countEl.textContent='â€¦'; await fetchPage() })
    document.getElementById('btnReset').addEventListener('click',()=>{ document.querySelectorAll('.filters input, .filters select').forEach(el=>el.value=''); page=1; fetchPage() })
    document.getElementById('prevBtn').addEventListener('click',()=>{ if(page>1){ page--; fetchPage() } })
    document.getElementById('nextBtn').addEventListener('click',()=>{ const size=Number(pageSizeSel.value); if(page*size<totalRows){ page++; fetchPage() } })
    pageSizeSel.addEventListener('change',()=>{ page=1; fetchPage() })

    // ---------- Ù‚Ø§Ù„Ø¨â€ŒÙ‡Ø§ ----------
    const tplSelect=document.getElementById('tplSelect'), previewBtn=document.getElementById('previewTpl')
    const previewWrap=document.getElementById('tplPreviewWrap'), previewFrame=document.getElementById('tplPreview')
    const sendBtn=document.getElementById('sendBulk'), subjectInput=document.getElementById('emailSubject')
    let templates=[], selectedTpl=null

    async function loadEmailTemplates(){
      const {data,error}=await supabase.from('email_templates').select('id,slug,html,variables').eq('is_active',true).order('slug',{ascending:true})
      if(error){ showError('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª Ù‚Ø§Ù„Ø¨â€ŒÙ‡Ø§',error); return }
      templates=data||[]
      tplSelect.innerHTML='<option value="">â€” Ø§Ù†ØªØ®Ø§Ø¨ Ù‚Ø§Ù„Ø¨ â€”</option>'+templates.map(t=>`<option value="${t.id}">${t.slug}</option>`).join('')
    }
    tplSelect.addEventListener('change',()=>{ const id=tplSelect.value; selectedTpl=templates.find(t=>String(t.id)===String(id))||null })

    function renderTemplate(html,data){
      return html.replace(/\{\{\s*(\w+)\s*\}\}/g,(_,key)=> (data[key]==null?'':String(data[key])))
    }

    function getSelectedRows(){
      const ids=Array.from(document.querySelectorAll('.rowSel:checked')).map(cb=>cb.getAttribute('data-id'))
      if(!ids.length) return []
      const byId=new Map(currentRows.map(r=>[String(r.id),r]))
      return ids.map(id=>byId.get(String(id))).filter(Boolean)
    }

    previewBtn.addEventListener('click',()=>{
      if(!selectedTpl){ alert('Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ù‚Ø§Ù„Ø¨ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯'); return }
      const rows=getSelectedRows(); if(!rows.length){ alert('Ù‡ÛŒÚ† Ú¯ÛŒØ±Ù†Ø¯Ù‡â€ŒØ§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡'); return }
      const r=rows[0]
      const htmlCompiled=renderTemplate(selectedTpl.html,{ contact_person:r.contact_person??'' })
      previewWrap.style.display='block'
      const doc=previewFrame.contentWindow.document; doc.open(); doc.write(htmlCompiled); doc.close()
    })

    sendBtn.addEventListener('click',async()=>{
      if(!selectedTpl){ alert('Ù‚Ø§Ù„Ø¨ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯'); return }
      const subject=subjectInput.value?.trim()||'Ø¨Ø¯ÙˆÙ† Ù…ÙˆØ¶ÙˆØ¹'
      const rows=getSelectedRows(); if(!rows.length){ alert('Ù‡ÛŒÚ† Ú¯ÛŒØ±Ù†Ø¯Ù‡â€ŒØ§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡'); return }

      // Ø¨Ø±Ø§ÛŒ payloadÙ‡Ø§ÛŒ Ø®ÛŒÙ„ÛŒ Ø¨Ø²Ø±Ú¯ØŒ Ø¯Ø³ØªÙ‡â€ŒØ§ÛŒ Ø¨ÙØ±Ø³Øª
      const chunk = (arr, size)=>arr.reduce((a,_,i)=>i%size? a : [...a, arr.slice(i,i+size)], [])
      const batches = chunk(rows, 100) // Ù‡Ø± Û±Û°Û° ØªØ§ ÛŒÚ© Ø¯Ø±Ø®ÙˆØ§Ø³Øª

      sendBtn.disabled=true
      for(let i=0;i<batches.length;i++){
        statusEl.textContent=`ğŸšš Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„â€¦ Ø¯Ø³ØªÙ‡ ${i+1}/${batches.length}`
        const payload={
          subject,
          items: batches[i].map(r=>({
            to:r.email,
            html:renderTemplate(selectedTpl.html,{ contact_person:r.contact_person??'' })
          }))
        }
        const { error } = await supabase.functions.invoke('send-batch-email',{ body:payload })
        if(error){ showError('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø§ÛŒÙ…ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ú¯Ø±ÙˆÙ‡ÛŒ', error); break }
      }
      sendBtn.disabled=false
      statusEl.textContent='âœ… Ø§Ø±Ø³Ø§Ù„ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯ (Ù„Ø§Ú¯â€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯)'
      alert('Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ ØµÙ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.')
    })

    // Ø´Ø±ÙˆØ¹
    await loadOptions(); await fetchPage(); await loadEmailTemplates()
  </script>
</body>
</html>

